name: üîÑ Mise √† jour et Publication Automatiques

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  VERSION_FILE: "gsql/__init__.py"
  REPO: gopu-inc/gsql

permissions:
  contents: write  # Permissions explicites pour le token
  packages: write
  id-token: write

jobs:
  # 1. D√âTECTION ET CALCUL DE VERSION
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.read-version.outputs.current_version }}
      new_version: ${{ steps.calculate.outputs.new_version }}
      version_type: ${{ steps.calculate.outputs.version_type }}
    steps:
      - name: üì• Checkout avec historique
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GB_TOKEN }}  # VOTRE TOKEN PERSONNEL
      
      - name: üîç Lire la version depuis __init__.py
        id: read-version
        run: |
          if [ -f "$VERSION_FILE" ]; then
            CURRENT_VERSION=$(python -c "
            import re
            with open('$VERSION_FILE', 'r') as f:
                content = f.read()
                match = re.search(r'__version__\s*=\s*[\"]([^\"]+)[\"]', content)
                if match:
                    print(match.group(1))
            " 2>/dev/null || echo "")
          fi
          
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION="0.1.0"
            echo "‚ö†Ô∏è Version non trouv√©e, utilisation par d√©faut: $CURRENT_VERSION"
          fi
          
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "üìå Version actuelle d√©tect√©e: $CURRENT_VERSION"
      
      - name: üßÆ Calculer la nouvelle version bas√©e sur le commit
        id: calculate
        run: |
          CURRENT_VERSION="${{ steps.read-version.outputs.current_version }}"
          
          # R√©cup√©rer le message du dernier commit
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "üìù Dernier commit: $COMMIT_MSG"
          
          # D√©terminer le type de version (Semantic Versioning)
          if echo "$COMMIT_MSG" | grep -q -E "BREAKING CHANGE|feat!|major:"; then
            VERSION_TYPE="major"
            echo "üéØ MAJOR version bump (changement cassant)"
          elif echo "$COMMIT_MSG" | grep -q -E "^feat:|^feature:|^enhancement:"; then
            VERSION_TYPE="minor" 
            echo "üéØ MINOR version bump (nouvelle fonctionnalit√©)"
          else
            VERSION_TYPE="patch"
            echo "üéØ PATCH version bump (correction ou maintenance)"
          fi
          
          # Calculer la nouvelle version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          case "$VERSION_TYPE" in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "üìà Nouvelle version calcul√©e: $NEW_VERSION"

  # 2. MISE √Ä JOUR DES FICHIERS ET PUSH AUTOMATIQUE
  update-and-push:
    runs-on: ubuntu-latest
    needs: detect-version
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: üì• Checkout avec votre token GB_TOKEN
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GB_TOKEN }}  # TOKEN AVEC PERMISSIONS D'√âCRITURE
          fetch-depth: 0
      
      - name: üîß Configuration Git avec vos infos
        run: |
          git config --global user.email "github-actions@$REPO"
          git config --global user.name "GitHub Actions Bot"
          git remote set-url origin https://x-access-token:${{ secrets.GB_TOKEN }}@github.com/$REPO.git
      
      - name: üîÑ Mettre √† jour TOUS les fichiers avec la nouvelle version
        run: |
          OLD_VERSION="${{ needs.detect-version.outputs.current_version }}"
          NEW_VERSION="${{ needs.detect-version.outputs.new_version }}"
          
          echo "üîÑ Mise √† jour globale: $OLD_VERSION ‚Üí $NEW_VERSION"
          
          # 1. Source de v√©rit√©: gsql/__init__.py
          sed -i "s/__version__ = [\"']$OLD_VERSION[\"']/__version__ = \"$NEW_VERSION\"/g" "$VERSION_FILE"
          echo "‚úÖ $VERSION_FILE mis √† jour"
          
          # 2. pyproject.toml (PyPI)
          for file in pyproject.toml setup.py setup.cfg; do
            if [ -f "$file" ]; then
              sed -i "s/version\s*=\s*[\"'][^\"']*[\"']/version = \"$NEW_VERSION\"/g" "$file" 2>/dev/null || true
              sed -i "s/version=['\"][^'\"]*['\"]/version='$NEW_VERSION'/g" "$file" 2>/dev/null || true
              echo "‚úÖ $file mis √† jour"
            fi
          done
          
          # 3. Dockerfile
          if [ -f "Dockerfile" ]; then
            sed -i "s/LABEL version=[\"'][^\"']*[\"']/LABEL version=\"$NEW_VERSION\"/g" Dockerfile 2>/dev/null || true
            sed -i "s/ARG VERSION=.*/ARG VERSION=$NEW_VERSION/g" Dockerfile 2>/dev/null || true
            sed -i "s/FROM.*gsql:.*/FROM ceoseshell\/gsql:$NEW_VERSION/g" Dockerfile 2>/dev/null || true
            echo "‚úÖ Dockerfile mis √† jour"
          fi
          
          # 4. Anaconda meta.yaml
          if [ -f "conda.recipe/meta.yaml" ]; then
            sed -i "s/version:\s*[\"'][^\"']*[\"']/version: \"$NEW_VERSION\"/g" conda.recipe/meta.yaml
            sed -i "s/number:\s*[0-9]*/number: ${{ github.run_number }}/g" conda.recipe/meta.yaml
            echo "‚úÖ conda.recipe/meta.yaml mis √† jour"
          fi
          
          # 5. README.md et documentation
          if [ -f "README.md" ]; then
            # Mettre √† jour toutes les occurrences de version
            sed -i "s/gsql==[0-9]\+\.[0-9]\+\.[0-9]\+/gsql==$NEW_VERSION/g" README.md 2>/dev/null || true
            sed -i "s/gsql:[0-9]\+\.[0-9]\+\.[0-9]\+/gsql:$NEW_VERSION/g" README.md 2>/dev/null || true
            sed -i "s/version-[0-9]\+\.[0-9]\+\.[0-9]\+/version-$NEW_VERSION/g" README.md 2>/dev/null || true
            sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/v$NEW_VERSION/g" README.md 2>/dev/null || true
            echo "‚úÖ README.md mis √† jour"
          fi
          
          # 6. V√©rifier les changements
          echo "üìã Fichiers modifi√©s:"
          git status --short
      
      - name: üíæ Commit et Push automatique des changements
        run: |
          NEW_VERSION="${{ needs.detect-version.outputs.new_version }}"
          
          # V√©rifier s'il y a des changements
          if git diff --quiet; then
            echo "‚ÑπÔ∏è Aucun changement d√©tect√©, version d√©j√† √† jour"
            exit 0
          fi
          
          # Commit avec message standard
          git add -A
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
          
          # Push vers la branche main
          echo "üöÄ Pushing changes to main branch..."
          git push origin HEAD:main
          
          echo "‚úÖ Changements pouss√©s avec succ√®s!"
          echo "üìå Nouvelle version: $NEW_VERSION"
      
      - name: üè∑Ô∏è Cr√©er et pousser un tag Git
        run: |
          NEW_VERSION="${{ needs.detect-version.outputs.new_version }}"
          TAG_NAME="v$NEW_VERSION"
          
          # Cr√©er le tag annot√©
          git tag -a "$TAG_NAME" -m "Release version $NEW_VERSION"
          
          # Pousser le tag
          echo "üè∑Ô∏è Creating tag: $TAG_NAME"
          git push origin "$TAG_NAME"
          
          echo "‚úÖ Tag $TAG_NAME cr√©√© et pouss√©"

  # 3. PUBLICATION DOCKER HUB
  docker-publish:
    runs-on: ubuntu-latest
    needs: update-and-push
    if: success()
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üê≥ Login √† Docker Hub
        uses: docker/login-action@v3
        with:
          username: ceoseshell
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: üê≥ Build et Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ceoseshell/gsql:latest
            ceoseshell/gsql:${{ needs.detect-version.outputs.new_version }}
          labels: |
            version=${{ needs.detect-version.outputs.new_version }}
            org.opencontainers.image.source=https://github.com/$REPO
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 4. PUBLICATION PYPI
  pypi-publish:
    runs-on: ubuntu-latest
    needs: update-and-push
    if: success()
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: üì¶ V√©rifier la version dans __init__.py
        run: |
          echo "üîç V√©rification de la version pour PyPI..."
          python -c "
          import re
          with open('$VERSION_FILE', 'r') as f:
              content = f.read()
              match = re.search(r'__version__\s*=\s*[\"]([^\"]+)[\"]', content)
              if match:
                  print(f'‚úÖ Version PyPI: {match.group(1)}')
                  if match.group(1) != '${{ needs.detect-version.outputs.new_version }}':
                      print('‚ùå ERREUR: Version incoh√©rente!')
                      exit(1)
              else:
                  print('‚ùå Version non trouv√©e')
                  exit(1)
          "
      
      - name: üèóÔ∏è Build Python Package
        run: |
          pip install build
          python -m build
      
      - name: üì§ Upload vers PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}

  # 5. PUBLICATION ANACONDA
  anaconda-publish:
    runs-on: ubuntu-latest
    needs: [update-and-push, pypi-publish]
    if: success()
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üêç Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          python-version: 3.10
      
      - name: üì¶ Installer conda-build
        run: conda install conda-build anaconda-client -y
      
      - name: üèóÔ∏è Build Conda Package
        run: |
          echo "üîç V√©rification meta.yaml..."
          grep "version:" conda.recipe/meta.yaml
          
          conda build conda.recipe/ --output-folder conda_pkg
          
          echo "üì¶ Packages g√©n√©r√©s:"
          find conda_pkg -name "*.tar.bz2" | xargs ls -la
      
      - name: üöÄ Upload vers Anaconda.org
        run: |
          PKG_FILE=$(find conda_pkg -name "*.tar.bz2" -type f | head -1)
          if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
            echo "üì§ Upload: $PKG_FILE"
            anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG_FILE"
            echo "‚úÖ Package upload√© avec succ√®s!"
          else
            echo "‚ùå ERREUR: Aucun package trouv√©"
            exit 1
          fi
        env:
          ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}

  # 6. CR√âATION DE RELEASE GITHUB
  github-release:
    runs-on: ubuntu-latest
    needs: [docker-publish, pypi-publish, anaconda-publish]
    if: success()
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üè∑Ô∏è Cr√©er GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.detect-version.outputs.new_version }}
          name: Release v${{ needs.detect-version.outputs.new_version }}
          body: |
            ## üöÄ Version ${{ needs.detect-version.outputs.new_version }}
            
            Publication automatique via GitHub Actions.
            
            ### üì¶ Installation
            
            **Docker:**
            ```bash
            docker pull ceoseshell/gsql:${{ needs.detect-version.outputs.new_version }}
            ```
            
            **PyPI:**
            ```bash
            pip install gsql==${{ needs.detect-version.outputs.new_version }}
            ```
            
            **Anaconda:**
            ```bash
            conda install -c ceoseshell gsql=${{ needs.detect-version.outputs.new_version }}
            ```
            
            ### üîó Liens
            - [Documentation](https://github.com/gopu-inc/gsql/wiki)
            - [Code source](https://github.com/gopu-inc/gsql/tree/v${{ needs.detect-version.outputs.new_version }})
            
            *Auto-g√©n√©r√© le ${{ github.event.head_commit.timestamp }}*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GB_TOKEN }}  # VOTRE TOKEN POUR LA RELEASE

  # 7. NOTIFICATION ET RAPPORT
  notification:
    runs-on: ubuntu-latest
    needs: [github-release]
    if: always()
    steps:
      - name: üìä Rapport de publication
        run: |
          echo "## üì¶ PUBLICATION TERMIN√âE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Version publi√©e: **${{ needs.detect-version.outputs.new_version }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üåê Disponible sur:" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Hub**: \`ceoseshell/gsql:${{ needs.detect-version.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **PyPI**: \`pip install gsql==${{ needs.detect-version.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY  
          echo "- **Anaconda**: \`conda install -c ceoseshell gsql=${{ needs.detect-version.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release**: [v${{ needs.detect-version.outputs.new_version }}](https://github.com/gopu-inc/gsql/releases/tag/v${{ needs.detect-version.outputs.new_version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéâ Toutes les plateformes sont synchronis√©es!" >> $GITHUB_STEP_SUMMARY
