name: ğŸ“¦ Publication Anaconda

on:
  push:
    branches: [main]

jobs:
  publish-conda:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          miniconda-version: "latest"
          activate-environment: base
      
      - name: ğŸ“¦ Installer outils
        shell: bash  # FORCER l'utilisation d'un shell login
        run: |
          conda install -y conda-build anaconda-client
          echo "âœ… Outils installÃ©s"
      
      - name: ğŸ—ï¸ Construire
        shell: bash  # FORCER l'utilisation d'un shell login
        run: |
          echo "ğŸ—ï¸ Construction du package..."
          conda build conda.recipe/ --output-folder ./output
          echo "ğŸ“¦ Construction terminÃ©e"
      
      - name: ğŸ” Trouver le package
        shell: bash  # FORCER l'utilisation d'un shell login
        run: |
          PKG=$(find ./output -name "*.conda" -o -name "*.tar.bz2" | head -1)
          if [ -n "$PKG" ]; then
            echo "âœ… Package trouvÃ©: $PKG"
            echo "package_path=$PKG" >> $GITHUB_ENV
          else
            echo "âŒ Aucun package trouvÃ©!"
            exit 1
          fi
      
      - name: ğŸš€ Publier sur Anaconda
        shell: bash  # FORCER l'utilisation d'un shell login
        run: |
          echo "ğŸš€ Publication sur Anaconda.org..."
          anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "${{ env.package_path }}"
          echo "âœ… Publication terminÃ©e!"
