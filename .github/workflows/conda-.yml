name: ğŸ“¦ Publication Anaconda

on:
  push:
    branches: main

jobs:
  conda:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ·ï¸ Lire version du tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ“¦ Version Anaconda: $VERSION"
      
      - name: ğŸ Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          python-version: 3.10
      
      - name: ğŸ“¦ Installer outils
        run: conda install conda-build anaconda-client -y
      
      - name: ğŸ” VÃ©rifier meta.yaml
        run: |
          if [ -f "conda.recipe/meta.yaml" ]; then
            echo "âœ… meta.yaml trouvÃ©"
          else
            echo "âŒ meta.yaml manquant"
            exit 1
          fi
      
      - name: ğŸ—ï¸ Build Package Conda
        run: |
          conda build conda.recipe/ --output-folder dist_conda
          echo "ğŸ“¦ Packages gÃ©nÃ©rÃ©s:"
          find dist_conda -name "*.tar.bz2" | xargs ls -la
      
      - name: ğŸš€ Upload Anaconda
        run: |
          PKG=$(find dist_conda -name "*.tar.bz2" -type f | head -1)
          if [ -n "$PKG" ]; then
            echo "ğŸ“¤ Upload: $PKG"
            anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG"
            echo "âœ… Anaconda: gsql=${{ env.VERSION }} publiÃ©"
          else
            echo "âŒ Aucun package trouvÃ©"
            exit 1
          fi
