name: ğŸ“¦ Publication Anaconda Automatique

on:
  push:
    branches: [main]  # Se dÃ©clenche sur chaque nouveau commit dans main

jobs:
  conda:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ·ï¸ DÃ©terminer la version
        id: version
        run: |
          # Version basÃ©e sur la date et le SHA du commit
          VERSION="$(date +%Y.%m.%d).${GITHUB_SHA:0:7}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ“¦ Version automatique: $VERSION"
      
      - name: ğŸ Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          miniconda-version: "latest"
      
      - name: ğŸ“¦ CrÃ©er meta.yaml dynamique
        run: |
          mkdir -p conda.recipe
          cat > conda.recipe/meta.yaml << EOF
package:
  name: gsql
  version: $VERSION

build:
  number: 0
  noarch: python
  script: python -m pip install . --no-deps -vv

requirements:
  host:
    - python >=3.8
    - pip
  run:
    - python >=3.8
    - click >=8.0.0
    - colorama >=0.4.4
    - pandas >=1.3.0
    - numpy >=1.21.0
    - nltk >=3.6.0

test:
  imports:
    - gsql

about:
  home: https://github.com/${{ github.repository }}
  license: MIT
  summary: Complete SQL Database System in Python with AI Integration
EOF
          echo "âœ… meta.yaml gÃ©nÃ©rÃ© avec version $VERSION"
      
      - name: ğŸ—ï¸ Construire et publier directement
        run: |
          # Activer conda
          source $CONDA/etc/profile.d/conda.sh
          conda activate base
          
          # Installer conda-build si nÃ©cessaire
          conda install -y conda-build anaconda-client
          
          # Construire directement depuis le code source
          conda build conda.recipe/ --output-folder . --no-anaconda-upload
          
          # Uploader vers Anaconda
          PKG_FILE=$(find . -name "gsql-$VERSION-*.tar.bz2" -type f | head -1)
          if [ -n "$PKG_FILE" ]; then
            echo "ğŸ“¤ Publication sur Anaconda..."
            anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG_FILE"
            echo "âœ… PubliÃ©: https://anaconda.org/ceoseshell/gsql"
          else
            echo "âŒ Aucun package trouvÃ©!"
            exit 1
          fi
      
      - name: âœ… Confirmation
        run: |
          echo "ğŸ‰ PUBLICATION ANACONDA AUTOMATIQUE RÃ‰USSIE!"
          echo "ğŸ“¦ Version: $VERSION"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”— https://anaconda.org/ceoseshell/gsql"
