name: ğŸ“¦ Publication Anaconda
on:
  # SEULEMENT sur les tags, PAS sur les branches
  push:
    tags:
      - 'v*'

jobs:
  conda:
    runs-on: ubuntu-latest
    # Optionnel : si vous avez d'autres jobs de publication
    # needs: [docker-publish, pypi-publish]
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important pour avoir les tags
      
      - name: ğŸ·ï¸ Extraire version du tag (CORRIGÃ‰)
        id: version
        run: |
          # VÃ©rifier que c'est bien un tag qui a dÃ©clenchÃ© le workflow
          if [[ "${{ github.ref }}" != refs/tags/* ]]; then
            echo "âŒ ERREUR : Ce workflow doit Ãªtre dÃ©clenchÃ© par un tag, pas une branche!"
            echo "   Trigger: ${{ github.ref }}"
            exit 1
          fi
          
          # Extraire proprement la version du tag
          VERSION="${GITHUB_REF#refs/tags/v}"
          
          # VÃ©rifier le format de version (doit Ãªtre X.Y.Z)
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ERREUR : Format de version invalide: $VERSION"
            echo "   Le tag doit suivre le format vX.Y.Z (ex: v3.0.1)"
            exit 1
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version extraite: $VERSION"
      
      - name: ğŸ Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          miniconda-version: "latest"
      
      - name: ğŸ“¦ Installer conda-build et anaconda-client
        shell: bash
        run: |
          $CONDA/bin/conda install -y conda-build anaconda-client
          $CONDA/bin/conda --version
          $CONDA/bin/conda-build --version
      
      - name: ğŸ” VÃ©rifier et mettre Ã  jour meta.yaml
        shell: bash
        run: |
          echo "ğŸ” Mise Ã  jour de conda.recipe/meta.yaml avec version: $VERSION"
          
          if [ -f "conda.recipe/meta.yaml" ]; then
            # CORRECTION : Mise Ã  jour robuste de la version
            sed -i "s#version:[[:space:]]*[\"'][0-9]\+\.[0-9]\+\.[0-9]\+[\"']#version: \"$VERSION\"#g" conda.recipe/meta.yaml
            
            # VÃ©rification
            echo "âœ… Version mise Ã  jour:"
            grep -E "version:[[:space:]]*\"" conda.recipe/meta.yaml
            
          else
            echo "âŒ ERREUR: conda.recipe/meta.yaml introuvable!"
            exit 1
          fi
      
      - name: ğŸ—ï¸ Construire le package Conda
        shell: bash
        run: |
          echo "ğŸ—ï¸ Construction du package Conda v$VERSION..."
          
          # Nettoyer les builds prÃ©cÃ©dentes
          rm -rf conda_pkg 2>/dev/null || true
          
          # Construire le package
          $CONDA/bin/conda-build conda.recipe/ --output-folder conda_pkg
          
          echo "ğŸ“¦ Package gÃ©nÃ©rÃ©:"
          find conda_pkg -name "*.tar.bz2" -type f | xargs ls -la
      
      - name: ğŸš€ Upload vers Anaconda.org
        shell: bash
        run: |
          PKG_FILE=$(find conda_pkg -name "*.tar.bz2" -type f | head -1)
          
          if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
            echo "ğŸ“¤ Upload de gsql-$VERSION vers Anaconda.org..."
            $CONDA/bin/anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG_FILE" --force
            echo "âœ… Package uploadÃ©: https://anaconda.org/ceoseshell/gsql"
          else
            echo "âŒ Aucun package trouvÃ©!"
            exit 1
          fi
      
      - name: âœ… Confirmation
        run: |
          echo "ğŸ‰ PUBLICATION ANACONDA TERMINÃ‰E !"
          echo "================================="
          echo "ğŸ“¦ gsql v$VERSION publiÃ© sur Anaconda.org"
          echo ""
          echo "ğŸ”— https://anaconda.org/ceoseshell/gsql"
          echo ""
          echo "ğŸ“¥ Installation:"
          echo "  conda install -c ceoseshell gsql=$VERSION"
