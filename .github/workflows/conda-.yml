name: ğŸ“¦ Publication Anaconda

on:
  push:
    tags:
      - 'v*'

jobs:
  conda:
    runs-on: ubuntu-latest
    # Si vous avez un workflow PyPI, ajoutez: needs: pypi
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ·ï¸ Extraire version du tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ“¦ Version: $VERSION"
      
      - name: ğŸ Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          miniconda-version: "latest"
      
      - name: ğŸ“¦ Installer conda-build et anaconda-client
        shell: bash
        run: |
          $CONDA/bin/conda install -y conda-build anaconda-client
          $CONDA/bin/conda --version
          $CONDA/bin/conda-build --version
      
      - name: ğŸ” PrÃ©parer meta.yaml
        shell: bash
        run: |
          echo "ğŸ” PrÃ©paration de conda.recipe/meta.yaml..."
          
          if [ -f "conda.recipe/meta.yaml" ]; then
            # Mettre Ã  jour la version
            sed -i "s#version:[[:space:]]*[\"'][0-9]\+\.[0-9]\+\.[0-9]\+[\"']#version: \"$VERSION\"#g" conda.recipe/meta.yaml
            
            # S'assurer que setuptools est prÃ©sent
            if ! grep -q "setuptools" conda.recipe/meta.yaml; then
              sed -i "/requirements:/a \  host:\n    - python >=3.8\n    - pip\n    - setuptools" conda.recipe/meta.yaml
            fi
            
            echo "âœ… meta.yaml prÃ©parÃ©"
          else
            echo "âŒ ERREUR: conda.recipe/meta.yaml introuvable!"
            exit 1
          fi
      
      - name: ğŸ—ï¸ Construire le package Conda
        shell: bash
        run: |
          echo "ğŸ—ï¸ Construction du package..."
          
          # Nettoyer les anciennes builds
          rm -rf conda_pkg 2>/dev/null || true
          
          # Construire le package
          $CONDA/bin/conda build conda.recipe/ --output-folder ./conda_pkg
          
          echo "ğŸ“¦ Packages gÃ©nÃ©rÃ©s dans ./conda_pkg/:"
          find ./conda_pkg -type f -name "*.conda" -o -name "*.tar.bz2" | xargs ls -la 2>/dev/null || echo "Aucun package trouvÃ©"
      
      - name: ğŸ” VÃ©rifier le package gÃ©nÃ©rÃ©
        shell: bash
        run: |
          echo "ğŸ” VÃ©rification du package..."
          
          # CORRECTION CRITIQUE : Chercher .conda puis .tar.bz2
          PKG_FILE=$(find ./conda_pkg -name "*.conda" -type f | head -1)
          
          if [ -z "$PKG_FILE" ]; then
            # Fallback sur l'ancien format
            PKG_FILE=$(find ./conda_pkg -name "*.tar.bz2" -type f | head -1)
          fi
          
          if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
            echo "âœ… Package trouvÃ©: $(basename "$PKG_FILE")"
            echo "ğŸ“ Taille: $(ls -lh "$PKG_FILE" | awk '{print $5}')"
            
            # Afficher des infos sur le package
            echo "ğŸ“‹ Informations:"
            if [[ "$PKG_FILE" == *.conda ]]; then
              $CONDA/bin/conda inspect metadata "$PKG_FILE" | grep -E "(name|version|build)" || true
            fi
          else
            echo "âŒ Aucun package trouvÃ© dans ./conda_pkg/"
            echo "Contenu du dossier:"
            ls -la ./conda_pkg/ 2>/dev/null || echo "Le dossier ./conda_pkg/ n'existe pas"
            exit 1
          fi
      
      - name: ğŸš€ Upload vers Anaconda.org (CORRIGÃ‰)
        shell: bash
        run: |
          echo "ğŸš€ DÃ©but de l'upload..."
          
          # CORRECTION : Recherche correcte du package
          PKG_FILE=$(find ./conda_pkg -name "*.conda" -type f | head -1)
          
          if [ -z "$PKG_FILE" ]; then
            PKG_FILE=$(find ./conda_pkg -name "*.tar.bz2" -type f | head -1)
          fi
          
          if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
            echo "ğŸ“¤ Upload du package: $(basename "$PKG_FILE")"
            
            # Upload avec token Anaconda
            $CONDA/bin/anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG_FILE"
            
            echo "âœ… Upload terminÃ© avec succÃ¨s !"
            echo "ğŸŒ Disponible sur: https://anaconda.org/ceoseshell/gsql"
          else
            echo "âŒ ERREUR CRITIQUE: Impossible de trouver le package pour l'upload"
            exit 1
          fi
      
      - name: âœ… Confirmation finale
        run: |
          echo ""
          echo "ğŸ‰ğŸ‰ğŸ‰ PUBLICATION ANACONDA RÃ‰USSIE ! ğŸ‰ğŸ‰ğŸ‰"
          echo "=========================================="
          echo "ğŸ“¦ Package: gsql"
          echo "ğŸ·ï¸ Version: $VERSION"
          echo "ğŸ‘¤ Channel: ceoseshell"
          echo ""
          echo "ğŸ”§ Installation:"
          echo "  conda install -c ceoseshell gsql=$VERSION"
          echo ""
          echo "ğŸ”— Lien direct:"
          echo "  https://anaconda.org/ceoseshell/gsql"
          echo ""
          echo "âœ… Toute la chaÃ®ne de publication est maintenant opÃ©rationnelle !"
