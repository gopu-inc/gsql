name: ğŸ“¦ Publication Anaconda

on:
  push:
    branches: main

jobs:
  conda:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ·ï¸ Extraire version du tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ“¦ Version Ã  publier: $VERSION"
      
      - name: ğŸ Setup Miniconda (CorrigÃ©)
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          activate-environment: ""
          miniconda-version: "24.1.2-0"
          python-version: "3.10"
          auto-update-conda: true
      
      - name: ğŸ“¦ Installer conda-build et anaconda-client
        run: |
          conda install -y conda-build anaconda-client
          conda --version
          conda-build --version
      
      - name: ğŸ” VÃ©rifier le meta.yaml existant
        run: |
          echo "ğŸ” VÃ©rification du meta.yaml existant..."
          
          if [ -f "conda.recipe/meta.yaml" ]; then
            echo "âœ… meta.yaml trouvÃ© dans conda.recipe/"
            echo "ğŸ“„ Contenu actuel :"
            cat conda.recipe/meta.yaml
            
            # VÃ©rifier que la version est mise Ã  jour
            CURRENT_VERSION=$(grep -E "version:\s*[\"'][0-9]+\.[0-9]+\.[0-9]+[\"']" conda.recipe/meta.yaml | sed -E "s/.*[\"']([0-9]+\.[0-9]+\.[0-9]+)[\"'].*/\1/" || echo "")
            
            if [ -n "$CURRENT_VERSION" ]; then
              echo "ğŸ“Œ Version actuelle dans meta.yaml: $CURRENT_VERSION"
              echo "ğŸ“Œ Version du tag: $VERSION"
              
              if [ "$CURRENT_VERSION" != "$VERSION" ]; then
                echo "âš ï¸ ATTENTION: La version dans meta.yaml ($CURRENT_VERSION) ne correspond pas au tag ($VERSION)"
                echo "   Le build utilisera la version du tag comme prioritÃ©."
              fi
            fi
          else
            echo "âŒ ERREUR: Fichier conda.recipe/meta.yaml introuvable !"
            echo "   Structure attendue:"
            echo "   â””â”€â”€ conda.recipe/"
            echo "       â””â”€â”€ meta.yaml"
            exit 1
          fi
      
      - name: ğŸ”„ Mettre Ã  jour la version dans meta.yaml (optionnel)
        run: |
          echo "ğŸ”„ Mise Ã  jour automatique de la version dans meta.yaml..."
          
          # Mettre Ã  jour la ligne "version:"
          sed -i "s/version:\s*[\"'][0-9]\+\.[0-9]\+\.[0-9]\+[\"']/version: \"$VERSION\"/g" conda.recipe/meta.yaml
          
          # IncrÃ©menter le build number
          if grep -q "number:" conda.recipe/meta.yaml; then
            CURRENT_NUMBER=$(grep "number:" conda.recipe/meta.yaml | sed -E 's/.*number:\s*([0-9]+).*/\1/')
            NEW_NUMBER=$((CURRENT_NUMBER + 1))
            sed -i "s/number:\s*[0-9]\+/number: $NEW_NUMBER/g" conda.recipe/meta.yaml
            echo "âœ… Build number incrÃ©mentÃ©: $CURRENT_NUMBER â†’ $NEW_NUMBER"
          fi
          
          echo "ğŸ“„ meta.yaml mis Ã  jour:"
          grep -E "(version:|number:)" conda.recipe/meta.yaml
      
      - name: ğŸ—ï¸ Construire le package Conda
        run: |
          echo "ğŸ—ï¸ Construction du package Conda avec VOTRE meta.yaml..."
          
          # Nettoyer les anciennes builds
          rm -rf conda_pkg output
          
          # Construire le package avec le meta.yaml existant
          conda build conda.recipe/ --output-folder conda_pkg
          
          echo "ğŸ“¦ Packages gÃ©nÃ©rÃ©s:"
          find conda_pkg -name "*.tar.bz2" | xargs ls -la
      
      - name: ğŸ” VÃ©rifier la structure du package
        run: |
          echo "ğŸ” VÃ©rification du package gÃ©nÃ©rÃ©..."
          PKG_FILE=$(find conda_pkg -name "*.tar.bz2" -type f | head -1)
          
          if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
            echo "âœ… Package trouvÃ©: $PKG_FILE"
            echo "ğŸ“ Taille: $(ls -lh "$PKG_FILE" | awk '{print $5}')"
            echo "ğŸ“‹ Contenu du package:"
            tar -tjf "$PKG_FILE" | head -20
          else
            echo "âŒ Aucun package trouvÃ©!"
            exit 1
          fi
      
      - name: ğŸš€ Upload vers Anaconda.org
        run: |
          PKG_FILE=$(find conda_pkg -name "*.tar.bz2" -type f | head -1)
          
          if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
            echo "ğŸ“¤ Upload du package vers Anaconda.org..."
            echo "ğŸ“¦ Fichier: $(basename "$PKG_FILE")"
            
            # Afficher des infos de debug
            echo "ğŸ” Informations du package:"
            tar -Oxf "$PKG_FILE" info/index.json | python -m json.tool | grep -E "(name|version|build)"
            
            # Uploader le package
            echo "ğŸš€ Upload en cours..."
            anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG_FILE" --force
            
            echo "âœ… Package uploadÃ© avec succÃ¨s!"
            echo "ğŸŒ Disponible sur: https://anaconda.org/ceoseshell/gsql"
          else
            echo "âŒ Aucun package Conda trouvÃ© pour l'upload"
            exit 1
          fi
      
      - name: âœ… VÃ©rification finale
        run: |
          echo "ğŸ‰ PUBLICATION ANACONDA RÃ‰USSIE !"
          echo "================================"
          echo "ğŸ“¦ Package: gsql"
          echo "ğŸ·ï¸ Version: $VERSION"
          echo "ğŸ‘¤ Channel: ceoseshell"
          echo ""
          echo "ğŸ”§ Installation:"
          echo "  conda install -c ceoseshell gsql=$VERSION"
          echo ""
          echo "ğŸ”— Liens:"
          echo "  ğŸ“ https://anaconda.org/ceoseshell/gsql"
          echo "  ğŸ“ https://anaconda.org/ceoseshell/gsql/files"
          echo ""
          echo "âœ… Utilisation de VOTRE fichier meta.yaml personnalisÃ©"
