name: ğŸ“¦ Publication Anaconda Automatique

on:
  push:
    branches: [main]

jobs:
  conda:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ·ï¸ DÃ©terminer la version
        id: version
        run: |
          VERSION="$(date +%Y.%m.%d).${GITHUB_SHA:0:7}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ“¦ Version: $VERSION"
      
      - name: ğŸ Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          miniconda-version: "latest"
      
      
      - name: ğŸ—ï¸ Construire et publier
        run: |
          source $CONDA/etc/profile.d/conda.sh
          conda activate base
          conda install -y conda-build anaconda-client
          
          conda build conda.recipe/ --output-folder ./conda_pkg
          
          PKG_FILE=$(find ./conda_pkg -name "gsql-$VERSION-*.tar.bz2" -type f | head -1)
          if [ -n "$PKG_FILE" ]; then
            anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG_FILE"
            echo "âœ… PubliÃ© sur Anaconda"
          else
            echo "âŒ Aucun package trouvÃ©"
            exit 1
          fi
      
      - name: âœ… Confirmation
        run: |
          echo "ğŸ‰ Publication automatique rÃ©ussie!"
          echo "ğŸ“¦ Version: $VERSION"
