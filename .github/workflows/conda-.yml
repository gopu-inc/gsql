name: ğŸ“¦ Publication Anaconda
on:
  push:
    branches: main

jobs:
  conda:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ·ï¸ Extraire version du tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ“¦ Version: $VERSION"
      
      - name: ğŸ Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          miniconda-version: "latest"
      
      - name: ğŸ“¦ Installer conda-build et anaconda-client
        shell: bash
        run: |
          $CONDA/bin/conda install -y conda-build anaconda-client
          $CONDA/bin/conda --version
          $CONDA/bin/conda-build --version
      
      - name: ğŸ” VÃ©rifier et mettre Ã  jour meta.yaml (CORRIGÃ‰)
        shell: bash
        run: |
          echo "ğŸ” VÃ©rification du meta.yaml..."
          
          if [ -f "conda.recipe/meta.yaml" ]; then
            echo "âœ… meta.yaml trouvÃ©"
            
            # CORRECTION : Utiliser un dÃ©limiteur diffÃ©rent pour sed (# au lieu de /)
            # Cela Ã©vite les problÃ¨mes quand la version contient des /
            sed -i "s#version:\s*[\"'][0-9]\+\.[0-9]\+\.[0-9]\+[\"']#version: \"$VERSION\"#g" conda.recipe/meta.yaml
            
            # Afficher la version mise Ã  jour
            echo "ğŸ“„ Version mise Ã  jour dans meta.yaml:"
            grep "version:" conda.recipe/meta.yaml
            
            # VÃ©rifier aussi la ligne source si elle existe
            if grep -q "source:" conda.recipe/meta.yaml; then
              sed -i "s#url:.*gsql-{{ version }}.tar.gz#url: https://pypi.io/packages/source/g/gsql/gsql-$VERSION.tar.gz#g" conda.recipe/meta.yaml 2>/dev/null || true
            fi
            
          else
            echo "âŒ ERREUR: conda.recipe/meta.yaml introuvable!"
            ls -la conda.recipe/ 2>/dev/null || echo "Dossier conda.recipe/ n'existe pas"
            exit 1
          fi
      
      - name: ğŸ—ï¸ Construire le package Conda
        shell: bash
        run: |
          echo "ğŸ—ï¸ Construction du package..."
          rm -rf conda_pkg 2>/dev/null || true
          
          # Utiliser le chemin complet de conda-build
          $CONDA/bin/conda-build conda.recipe/ --output-folder conda_pkg
          
          echo "ğŸ“¦ Packages gÃ©nÃ©rÃ©s:"
          find conda_pkg -name "*.tar.bz2" 2>/dev/null | while read file; do
            echo "  - $(basename "$file") ($(ls -lh "$file" | awk '{print $5}'))"
          done || echo "Aucun package trouvÃ©"
      
      - name: ğŸ” VÃ©rifier le package
        shell: bash
        run: |
          echo "ğŸ” VÃ©rification du package..."
          PKG_FILE=$(find conda_pkg -name "*.tar.bz2" -type f 2>/dev/null | head -1)
          
          if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
            echo "âœ… Package trouvÃ©: $(basename "$PKG_FILE")"
            
            # VÃ©rifier le contenu
            echo "ğŸ“‹ Contenu du package:"
            tar -tjf "$PKG_FILE" | grep -E "(info/|gsql/)" | head -5
            
          else
            echo "âŒ Aucun package trouvÃ©!"
            exit 1
          fi
      
      - name: ğŸš€ Upload vers Anaconda.org
        shell: bash
        run: |
          PKG_FILE=$(find conda_pkg -name "*.tar.bz2" -type f | head -1)
          
          if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
            echo "ğŸ“¤ Upload du package vers Anaconda.org..."
            
            # Utiliser le chemin complet pour anaconda
            $CONDA/bin/anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG_FILE" --force
            
            echo "âœ… Package uploadÃ© avec succÃ¨s!"
            echo "ğŸŒ Disponible sur: https://anaconda.org/ceoseshell/gsql"
          else
            echo "âŒ Aucun package trouvÃ© pour l'upload"
            exit 1
          fi
      
      - name: âœ… Confirmation finale
        run: |
          echo "ğŸ‰ PUBLICATION ANACONDA RÃ‰USSIE !"
          echo "================================"
          echo "ğŸ“¦ Package: gsql"
          echo "ğŸ·ï¸ Version: $VERSION"
          echo "ğŸ‘¤ Channel: ceoseshell"
          echo ""
          echo "ğŸ”§ Installation:"
          echo "  conda install -c ceoseshell gsql=$VERSION"
          echo ""
          echo "ğŸ”— Lien: https://anaconda.org/ceoseshell/gsql"
