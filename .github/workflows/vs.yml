name: üîÑ Synchronisation Automatique des Versions

on:
  push:
    tags:
      - 'v*'  # Se d√©clenche uniquement sur les tags de version (v1.0.0, v2.3.4, etc.)
    branches:
      - main  # Optionnel: pour v√©rifier la coh√©rence

env:
  VERSION_FILE: "gsql/__init__.py"
  DOCKER_FILE: "Dockerfile"
  CONDA_FILE: "conda.recipe/meta.yaml"

permissions:
  contents: write
  pull-requests: write

jobs:
  # 1. VALIDATION ET SYNCHRONISATION DES VERSIONS
  sync-versions:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: üì• Checkout avec le tag
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.ref }}
      
      - name: üè∑Ô∏è Extraire la version du tag
        id: extract-tag
        run: |
          # Extraire la version du tag (ex: v3.0.2 -> 3.0.2)
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          echo "üìå Version du tag: $TAG_VERSION"
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
      
      - name: üîç V√©rifier les versions actuelles
        id: check-versions
        run: |
          TAG_VERSION="${{ steps.extract-tag.outputs.tag_version }}"
          
          echo "üîç V√©rification des versions dans les fichiers..."
          
          # 1. V√©rifier gsql/__init__.py
          if [ -f "$VERSION_FILE" ]; then
            PY_VERSION=$(grep -E "__version__\s*=\s*[\"'][0-9]+\.[0-9]+\.[0-9]+[\"']" "$VERSION_FILE" | head -1 | sed -E "s/.*[\"']([0-9]+\.[0-9]+\.[0-9]+)[\"'].*/\1/")
            echo "üêç gsql/__init__.py: $PY_VERSION"
            
            if [ "$PY_VERSION" != "$TAG_VERSION" ]; then
              echo "üîÑ √Ä synchroniser: Python ($PY_VERSION ‚Üí $TAG_VERSION)"
              echo "update_python=true" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ Python d√©j√† synchronis√©"
              echo "update_python=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Fichier $VERSION_FILE non trouv√©"
            exit 1
          fi
          
          # 2. V√©rifier Dockerfile
          if [ -f "$DOCKER_FILE" ]; then
            # Chercher ARG VERSION ou LABEL version
            DOCKER_VERSION=$(grep -E "ARG VERSION=|LABEL version=" "$DOCKER_FILE" | head -1 | sed -E "s/.*[\"']?([0-9]+\.[0-9]+\.[0-9]+)[\"']?.*/\1/" | sed -E "s/VERSION=//")
            
            if [ -n "$DOCKER_VERSION" ]; then
              echo "üê≥ Dockerfile: $DOCKER_VERSION"
              
              if [ "$DOCKER_VERSION" != "$TAG_VERSION" ]; then
                echo "üîÑ √Ä synchroniser: Docker ($DOCKER_VERSION ‚Üí $TAG_VERSION)"
                echo "update_docker=true" >> $GITHUB_OUTPUT
              else
                echo "‚úÖ Docker d√©j√† synchronis√©"
                echo "update_docker=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "‚ö†Ô∏è Version non trouv√©e dans Dockerfile"
              echo "update_docker=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          # 3. V√©rifier conda meta.yaml
          if [ -f "$CONDA_FILE" ]; then
            CONDA_VERSION=$(grep -E "version:\s*[\"'][0-9]+\.[0-9]+\.[0-9]+[\"']" "$CONDA_FILE" | head -1 | sed -E "s/.*[\"']([0-9]+\.[0-9]+\.[0-9]+)[\"'].*/\1/")
            
            if [ -n "$CONDA_VERSION" ]; then
              echo "üì¶ conda.recipe/meta.yaml: $CONDA_VERSION"
              
              if [ "$CONDA_VERSION" != "$TAG_VERSION" ]; then
                echo "üîÑ √Ä synchroniser: Conda ($CONDA_VERSION ‚Üí $TAG_VERSION)"
                echo "update_conda=true" >> $GITHUB_OUTPUT
              else
                echo "‚úÖ Conda d√©j√† synchronis√©"
                echo "update_conda=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "‚ö†Ô∏è Version non trouv√©e dans meta.yaml"
              echo "update_conda=true" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: üîÑ Synchroniser les versions si n√©cessaire
        id: sync
        # S'ex√©cute seulement si au moins un fichier doit √™tre mis √† jour
        if: steps.check-versions.outputs.update_python == 'true' || steps.check-versions.outputs.update_docker == 'true' || steps.check-versions.outputs.update_conda == 'true'
        run: |
          TAG_VERSION="${{ steps.extract-tag.outputs.tag_version }}"
          
          echo "üîÑ Synchronisation avec la version: $TAG_VERSION"
          
          # 1. Synchroniser gsql/__init__.py
          if [ "${{ steps.check-versions.outputs.update_python }}" = "true" ]; then
            echo "üìù Mise √† jour de $VERSION_FILE"
            # Trouver et remplacer la ligne __version__
            sed -i "s/__version__\s*=\s*[\"'][0-9]\+\.[0-9]\+\.[0-9]\+[\"']/__version__ = \"$TAG_VERSION\"/g" "$VERSION_FILE"
            echo "‚úÖ $VERSION_FILE mis √† jour vers $TAG_VERSION"
          fi
          
          # 2. Synchroniser Dockerfile
          if [ "${{ steps.check-versions.outputs.update_docker }}" = "true" ]; then
            echo "üìù Mise √† jour de $DOCKER_FILE"
            
            # Mettre √† jour ARG VERSION
            sed -i "s/ARG VERSION=.*/ARG VERSION=\"$TAG_VERSION\"/g" "$DOCKER_FILE" 2>/dev/null || true
            
            # Mettre √† jour LABEL version
            sed -i "s/LABEL version=.*/LABEL version=\"$TAG_VERSION\"/g" "$DOCKER_FILE" 2>/dev/null || true
            
            # Si aucune des deux lignes n'existe, les ajouter
            if ! grep -q "ARG VERSION=" "$DOCKER_FILE" 2>/dev/null; then
              # Trouver la ligne FROM et ajouter ARG apr√®s
              sed -i "/^FROM /a ARG VERSION=\"$TAG_VERSION\"" "$DOCKER_FILE"
            fi
            
            if ! grep -q "LABEL version=" "$DOCKER_FILE" 2>/dev/null; then
              # Ajouter LABEL apr√®s ARG
              sed -i "/ARG VERSION=.*/a LABEL version=\"$TAG_VERSION\"" "$DOCKER_FILE"
            fi
            
            echo "‚úÖ $DOCKER_FILE mis √† jour vers $TAG_VERSION"
          fi
          
          # 3. Synchroniser conda meta.yaml
          if [ "${{ steps.check-versions.outputs.update_conda }}" = "true" ]; then
            echo "üìù Mise √† jour de $CONDA_FILE"
            
            # Mettre √† jour la version
            sed -i "s/version:\s*[\"'][0-9]\+\.[0-9]\+\.[0-9]\+[\"']/version: \"$TAG_VERSION\"/g" "$CONDA_FILE" 2>/dev/null || true
            
            # Si la ligne version n'existe pas, l'ajouter
            if ! grep -q "version:" "$CONDA_FILE" 2>/dev/null; then
              # Trouver la section package et ajouter version apr√®s
              sed -i "/^package:/a \  version: \"$TAG_VERSION\"" "$CONDA_FILE"
            fi
            
            # Incr√©menter le build number
            if grep -q "number:" "$CONDA_FILE" 2>/dev/null; then
              # R√©cup√©rer le num√©ro actuel et l'incr√©menter
              CURRENT_NUMBER=$(grep "number:" "$CONDA_FILE" | sed -E 's/.*number:\s*([0-9]+).*/\1/')
              NEW_NUMBER=$((CURRENT_NUMBER + 1))
              sed -i "s/number:\s*[0-9]\+/number: $NEW_NUMBER/g" "$CONDA_FILE"
            else
              # Ajouter le build number
              sed -i "/version:/a \  number: 0" "$CONDA_FILE"
            fi
            
            echo "‚úÖ $CONDA_FILE mis √† jour vers $TAG_VERSION"
          fi
          
          # Afficher les changements
          echo "üìã Diff√©rences apr√®s synchronisation:"
          git diff --name-only
      
      - name: üíæ Commit et push des changements
        if: steps.check-versions.outputs.update_python == 'true' || steps.check-versions.outputs.update_docker == 'true' || steps.check-versions.outputs.update_conda == 'true'
        run: |
          TAG_VERSION="${{ steps.extract-tag.outputs.tag_version }}"
          
          # Configurer Git
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          
          # V√©rifier s'il y a des changements
          if git diff --quiet; then
            echo "‚ÑπÔ∏è Aucun changement √† commiter"
            exit 0
          fi
          
          # Commiter les changements
          git add -A
          git commit -m "chore: sync versions to $TAG_VERSION [skip ci]"
          
          # Pousser vers la branche principale
          echo "üöÄ Pushing synchronized versions to main..."
          git push origin HEAD:main
          
          echo "‚úÖ Versions synchronis√©es sur main"
          
          # Mettre √† jour le tag avec les nouveaux fichiers
          echo "üè∑Ô∏è Mise √† jour du tag avec les fichiers synchronis√©s..."
          git tag -f "v$TAG_VERSION"
          git push --force origin "v$TAG_VERSION"
          
          echo "üéâ Synchronisation termin√©e! Tag mis √† jour avec les versions correctes."

  # 2. PUBLICATION MULTI-PLATEFORMES (d√©clench√© apr√®s synchronisation)
  publish-all:
    runs-on: ubuntu-latest
    needs: sync-versions
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    env:
      VERSION: ${{ github.ref_name }}
    
    steps:
      - name: üì• Checkout avec le tag synchronis√©
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ‚úÖ V√©rifier que toutes les versions sont synchronis√©es
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          echo "üîç V√©rification finale des versions pour $TAG_VERSION"
          
          # V√©rifier Python
          if [ -f "$VERSION_FILE" ]; then
            PY_VERSION=$(grep -E "__version__\s*=\s*[\"'][0-9]+\.[0-9]+\.[0-9]+[\"']" "$VERSION_FILE" | head -1 | sed -E "s/.*[\"']([0-9]+\.[0-9]+\.[0-9]+)[\"'].*/\1/")
            if [ "$PY_VERSION" != "$TAG_VERSION" ]; then
              echo "‚ùå ERREUR: Version Python ($PY_VERSION) ‚â† Tag ($TAG_VERSION)"
              exit 1
            fi
            echo "‚úÖ Python: $PY_VERSION"
          fi
          
          # V√©rifier Docker
          if [ -f "$DOCKER_FILE" ]; then
            DOCKER_VERSION=$(grep -E "ARG VERSION=|LABEL version=" "$DOCKER_FILE" | head -1 | sed -E "s/.*[\"']?([0-9]+\.[0-9]+\.[0-9]+)[\"']?.*/\1/")
            if [ -n "$DOCKER_VERSION" ] && [ "$DOCKER_VERSION" != "$TAG_VERSION" ]; then
              echo "‚ùå ERREUR: Version Docker ($DOCKER_VERSION) ‚â† Tag ($TAG_VERSION)"
              exit 1
            fi
            echo "‚úÖ Docker: $DOCKER_VERSION"
          fi
          
          # V√©rifier Conda
          if [ -f "$CONDA_FILE" ]; then
            CONDA_VERSION=$(grep -E "version:\s*[\"'][0-9]+\.[0-9]+\.[0-9]+[\"']" "$CONDA_FILE" | head -1 | sed -E "s/.*[\"']([0-9]+\.[0-9]+\.[0-9]+)[\"'].*/\1/")
            if [ -n "$CONDA_VERSION" ] && [ "$CONDA_VERSION" != "$TAG_VERSION" ]; then
              echo "‚ùå ERREUR: Version Conda ($CONDA_VERSION) ‚â† Tag ($TAG_VERSION)"
              exit 1
            fi
            echo "‚úÖ Conda: $CONDA_VERSION"
          fi
          
          echo "üéâ Toutes les versions sont synchronis√©es avec $TAG_VERSION"
      
      - name: üê≥ Publication Docker Hub
        uses: docker/login-action@v3
        with:
          username: ceoseshell
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: üê≥ Build & Push Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ceoseshell/gsql:latest
            ceoseshell/gsql:${{ env.VERSION }}
          build-args: |
            VERSION=${{ env.VERSION }}
          labels: |
            version=${{ env.VERSION }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
      
      - name: üêç Publication PyPI
        run: |
          pip install build
          python -m build
          twine upload --username __token__ --password ${{ secrets.PYPI_TOKEN }} dist/*
      
      - name: üì¶ Publication Anaconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
      
      - name: üèóÔ∏è Build Conda Package
        run: |
          conda install conda-build anaconda-client -y
          conda build conda.recipe/ --output-folder conda_pkg
      
      - name: üöÄ Upload Anaconda
        run: |
          PKG_FILE=$(find conda_pkg -name "*.tar.bz2" -type f | head -1)
          if [ -n "$PKG_FILE" ]; then
            anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG_FILE"
          fi
      
      - name: üè∑Ô∏è GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release ${{ env.VERSION }}
          body: |
            ## üöÄ Version ${{ env.VERSION }}
            
            Publication automatique avec versions synchronis√©es.
            
            ### üì¶ Installation
            
            **Docker:**
            ```bash
            docker pull ceoseshell/gsql:${{ env.VERSION }}
            ```
            
            **PyPI:**
            ```bash
            pip install gsql==${{ env.VERSION }}
            ```
            
            **Anaconda:**
            ```bash
            conda install -c ceoseshell gsql=${{ env.VERSION }}
            ```
            
            ### üîÑ Synchronisation
            - ‚úÖ gsql/__init__.py: ${{ env.VERSION }}
            - ‚úÖ Dockerfile: ${{ env.VERSION }}
            - ‚úÖ conda.recipe/meta.yaml: ${{ env.VERSION }}
            
            *Auto-g√©n√©r√© le ${{ github.event.head_commit.timestamp }}*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
