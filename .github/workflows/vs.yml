name: ðŸš€ Publication Automatique sur Tag

on:
  push:
    tags:
      - 'v*'  # SEULEMENT dÃ©clenchÃ© par les tags comme v3.0.2

env:
  VERSION_FILE: "gsql/__init__.py"
  DOCKER_FILE: "Dockerfile"
  CONDA_FILE: "conda.recipe/meta.yaml"
  SETUP_FILE: "setup.py"

permissions:
  contents: write

jobs:
  # 1. SYNCHRONISATION DES VERSIONS
  sync-versions:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout avec le tag
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ·ï¸ Extraire la version du tag
        id: extract-tag
        run: |
          # Extraire la version du tag (ex: v3.0.2 -> 3.0.2)
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          echo "ðŸ·ï¸ Tag dÃ©tectÃ©: $TAG_VERSION"
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          
          # VÃ©rifier le format de version
          if ! echo "$TAG_VERSION" | grep -q -E '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "âŒ Format de tag invalide. Doit Ãªtre vX.Y.Z (ex: v1.0.0)"
            exit 1
          fi
      
      - name: ðŸ”„ Synchroniser TOUS les fichiers
        run: |
          TAG_VERSION="${{ steps.extract-tag.outputs.tag_version }}"
          echo "ðŸ”„ Synchronisation complÃ¨te vers: $TAG_VERSION"
          
          # 1. Mettre Ã  jour gsql/__init__.py (source principale)
          if [ -f "$VERSION_FILE" ]; then
            # Trouver et remplacer __version__ = "x.y.z"
            sed -i "s/__version__\s*=\s*[\"'][0-9]\+\.[0-9]\+\.[0-9]\+[\"']/__version__ = \"$TAG_VERSION\"/g" "$VERSION_FILE"
            echo "âœ… $VERSION_FILE â†’ $TAG_VERSION"
          else
            echo "âŒ Fichier $VERSION_FILE introuvable"
            exit 1
          fi
          
          # 2. Mettre Ã  jour Dockerfile (CRITIQUE: avec les bonnes guillemets)
          if [ -f "$DOCKER_FILE" ]; then
            # A. Mettre Ã  jour ARG VERSION (exactement comme dans votre Dockerfile)
            sed -i "s/ARG VERSION=\".*\"/ARG VERSION=\"$TAG_VERSION\"/g" "$DOCKER_FILE"
            
            # B. Mettre Ã  jour LABEL version (exactement comme dans votre Dockerfile)
            sed -i "s/LABEL version=\".*\"/LABEL version=\"$TAG_VERSION\"/g" "$DOCKER_FILE"
            
            # VÃ©rification
            echo "ðŸ” VÃ©rification Dockerfile:"
            grep -E "(ARG VERSION|LABEL version)" "$DOCKER_FILE"
            echo "âœ… Dockerfile synchronisÃ©"
          fi
          
          # 3. Mettre Ã  jour conda meta.yaml
          if [ -f "$CONDA_FILE" ]; then
            # Version principale
            sed -i "s/version:\s*[\"'][0-9]\+\.[0-9]\+\.[0-9]\+[\"']/version: \"$TAG_VERSION\"/g" "$CONDA_FILE"
            
            # IncrÃ©menter le build number si existe
            if grep -q "number:" "$CONDA_FILE"; then
              CURRENT_NUMBER=$(grep "number:" "$CONDA_FILE" | sed -E 's/.*number:\s*([0-9]+).*/\1/')
              NEW_NUMBER=$((CURRENT_NUMBER + 1))
              sed -i "s/number:\s*[0-9]\+/number: $NEW_NUMBER/g" "$CONDA_FILE"
              echo "âœ… Build number: $CURRENT_NUMBER â†’ $NEW_NUMBER"
            fi
            echo "âœ… $CONDA_FILE synchronisÃ©"
          fi
          
          # 4. Mettre Ã  jour setup.py (VOTRE FICHIER COMPLEXE)
          if [ -f "$SETUP_FILE" ]; then
            # IMPORTANT: setup.py utilise VersionManager qui lit __init__.py
            # Donc pas besoin de modifier setup.py directement
            # Mais on peut mettre Ã  jour la version par dÃ©faut si nÃ©cessaire
            
            # VÃ©rifier si setup.py a une version codÃ©e en dur
            if grep -q "default_version = " "$SETUP_FILE"; then
              sed -i "s/default_version = \".*\"/default_version = \"$TAG_VERSION\"/g" "$SETUP_FILE"
              echo "âœ… Version par dÃ©faut dans setup.py mise Ã  jour"
            fi
            
            # Mettre Ã  jour la version dans le titre si prÃ©sent
            sed -i "s/GSQL v[0-9]\+\.[0-9]\+\.[0-9]\+/GSQL v$TAG_VERSION/g" "$SETUP_FILE" 2>/dev/null || true
            
            echo "âœ… setup.py vÃ©rifiÃ©"
          fi
          
          # 5. Mettre Ã  jour README.md
          if [ -f "README.md" ]; then
            # Remplacer toutes les occurrences de version
            sed -i "s/gsql==[0-9]\+\.[0-9]\+\.[0-9]\+/gsql==$TAG_VERSION/g" "README.md" 2>/dev/null || true
            sed -i "s/gsql:[0-9]\+\.[0-9]\+\.[0-9]\+/gsql:$TAG_VERSION/g" "README.md" 2>/dev/null || true
            sed -i "s/version [0-9]\+\.[0-9]\+\.[0-9]\+/version $TAG_VERSION/g" "README.md" 2>/dev/null || true
            sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/v$TAG_VERSION/g" "README.md" 2>/dev/null || true
            echo "âœ… README.md synchronisÃ©"
          fi
          
          # Afficher les changements
          echo "ðŸ“‹ Fichiers modifiÃ©s:"
          git status --short
      
      - name: ðŸ’¾ Commit et push des changements
        run: |
          TAG_VERSION="${{ steps.extract-tag.outputs.tag_version }}"
          
          # Configurer Git
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          
          # VÃ©rifier s'il y a des changements
          if git diff --quiet; then
            echo "â„¹ï¸ Aucun changement Ã  commiter (dÃ©jÃ  synchronisÃ©)"
            exit 0
          fi
          
          # Afficher les diffÃ©rences
          echo "ðŸ“‹ DiffÃ©rences dÃ©tectÃ©es:"
          git diff --name-only
          
          # Commiter les changements
          git add -A
          git commit -m "chore: sync all versions to $TAG_VERSION [skip ci]"
          
          # Pousser vers la branche main
          echo "ðŸš€ Pushing synchronized versions to main..."
          git push origin HEAD:main
          
          echo "âœ… Versions synchronisÃ©es sur main"
      
      - name: ðŸ“ VÃ©rification finale
        run: |
          TAG_VERSION="${{ steps.extract-tag.outputs.tag_version }}"
          echo "ðŸ” VÃ©rification finale:"
          
          # VÃ©rifier gsql/__init__.py
          PY_VERSION=$(grep -E "__version__\s*=\s*[\"'][0-9]+\.[0-9]+\.[0-9]+[\"']" "$VERSION_FILE" | head -1 | sed -E "s/.*[\"']([0-9]+\.[0-9]+\.[0-9]+)[\"'].*/\1/")
          echo "ðŸ gsql/__init__.py: $PY_VERSION"
          
          # VÃ©rifier Dockerfile
          if [ -f "$DOCKER_FILE" ]; then
            DOCKER_ARG=$(grep "ARG VERSION=" "$DOCKER_FILE" | head -1)
            DOCKER_LABEL=$(grep "LABEL version=" "$DOCKER_FILE" | head -1)
            echo "ðŸ³ Dockerfile - $DOCKER_ARG"
            echo "ðŸ³ Dockerfile - $DOCKER_LABEL"
          fi
          
          if [ "$PY_VERSION" = "$TAG_VERSION" ]; then
            echo "ðŸŽ‰ Toutes les versions sont synchronisÃ©es avec $TAG_VERSION"
          else
            echo "âŒ ERREUR: Version non synchronisÃ©e"
            exit 1
          fi

  # 2. PUBLICATION DOCKER HUB
  publish-docker:
    runs-on: ubuntu-latest
    needs: sync-versions
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ³ Login Ã  Docker Hub
        uses: docker/login-action@v3
        with:
          username: ceoseshell
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: ðŸ” Extraire la version pour Docker
        id: docker-version
        run: |
          # Extraire la version du tag
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          echo "ðŸ·ï¸ Version pour Docker: $TAG_VERSION"
          
          # VÃ©rifier le Dockerfile
          if [ -f "Dockerfile" ]; then
            echo "ðŸ” VÃ©rification Dockerfile:"
            grep -E "(ARG VERSION|LABEL version)" "Dockerfile"
          fi
          
          echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
      
      - name: ðŸ³ Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ceoseshell/gsql:latest
            ceoseshell/gsql:${{ steps.docker-version.outputs.version }}
          build-args: |
            VERSION=${{ steps.docker-version.outputs.version }}
          labels: |
            version=${{ steps.docker-version.outputs.version }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
      
      - name: âœ… VÃ©rification Docker
        run: |
          echo "âœ… Image Docker publiÃ©e:"
          echo "   ceoseshell/gsql:latest"
          echo "   ceoseshell/gsql:${{ steps.docker-version.outputs.version }}"

  # 3. PUBLICATION PYPI (avec votre setup.py)
  publish-pypi:
    runs-on: ubuntu-latest
    needs: sync-versions
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: ðŸ” VÃ©rifier la version dans gsql/__init__.py
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          
          if [ -f "gsql/__init__.py" ]; then
            PY_VERSION=$(grep -E "__version__\s*=\s*[\"'][0-9]+\.[0-9]+\.[0-9]+[\"']" "gsql/__init__.py" | head -1 | sed -E "s/.*[\"']([0-9]+\.[0-9]+\.[0-9]+)[\"'].*/\1/")
            
            if [ "$PY_VERSION" != "$TAG_VERSION" ]; then
              echo "âŒ ERREUR: Version Python ($PY_VERSION) â‰  Tag ($TAG_VERSION)"
              exit 1
            fi
            
            echo "âœ… Version PyPI: $PY_VERSION"
          fi
      
      - name: ðŸ“¦ Construire le package avec votre setup.py
        run: |
          echo "ðŸ—ï¸ Construction du package avec votre setup.py intelligent..."
          
          # Installer les dÃ©pendances minimales
          pip install build wheel setuptools
          
          # Tester le setup.py
          python setup.py --version
          
          # Construire les distributions
          python -m build
          
          echo "ðŸ“¦ Packages construits:"
          ls -la dist/
      
      - name: ðŸ“¤ Upload vers PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}

  # 4. PUBLICATION ANACONDA
  publish-anaconda:
    runs-on: ubuntu-latest
    needs: [sync-versions, publish-pypi]  # Attendre PyPI
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          python-version: 3.10
      
      - name: ðŸ“¦ Installer conda-build
        run: conda install conda-build anaconda-client -y
      
      - name: ðŸ” VÃ©rifier meta.yaml
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          
          if [ -f "conda.recipe/meta.yaml" ]; then
            echo "ðŸ” Contenu de meta.yaml:"
            grep -E "(version:|number:)" "conda.recipe/meta.yaml"
            
            CONDA_VERSION=$(grep "version:" "conda.recipe/meta.yaml" | sed -E 's/.*version:\s*[\"]([^\"]+)[\"].*/\1/')
            
            if [ "$CONDA_VERSION" != "$TAG_VERSION" ]; then
              echo "âŒ ERREUR: Version Conda ($CONDA_VERSION) â‰  Tag ($TAG_VERSION)"
              exit 1
            fi
            
            echo "âœ… Version Conda: $CONDA_VERSION"
          else
            echo "âš ï¸ Fichier conda.recipe/meta.yaml non trouvÃ©"
            # CrÃ©er un meta.yaml basique si nÃ©cessaire
            mkdir -p conda.recipe
            cat > conda.recipe/meta.yaml << EOF
package:
  name: gsql
  version: "$TAG_VERSION"

source:
  url: https://pypi.io/packages/source/g/gsql/gsql-\{\{ version \}\}.tar.gz

build:
  number: 0
  script: python -m pip install . --no-deps -vv

requirements:
  host:
    - python
    - pip
  run:
    - python

test:
  imports:
    - gsql

about:
  home: https://github.com/gopu-inc/gsql
  license: MIT
  summary: Complete SQL Database System in Python with AI Integration
EOF
            echo "âœ… meta.yaml crÃ©Ã© automatiquement"
          fi
      
      - name: ðŸ—ï¸ Build Conda Package
        run: |
          conda build conda.recipe/ --output-folder conda_pkg
          
          echo "ðŸ“¦ Packages gÃ©nÃ©rÃ©s:"
          find conda_pkg -name "*.tar.bz2" | xargs ls -la
      
      - name: ðŸš€ Upload vers Anaconda
        run: |
          PKG_FILE=$(find conda_pkg -name "*.tar.bz2" -type f | head -1)
          if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
            echo "ðŸ“¤ Upload du package: $PKG_FILE"
            anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG_FILE"
            echo "âœ… Package uploadÃ© avec succÃ¨s!"
          else
            echo "âŒ Aucun package Conda trouvÃ©"
            exit 1
          fi

  # 5. GITHUB RELEASE
  github-release:
    runs-on: ubuntu-latest
    needs: [publish-docker, publish-pypi, publish-anaconda]
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ·ï¸ CrÃ©er la Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release v${GITHUB_REF#refs/tags/v}
          body: |
            ## ðŸš€ GSQL v${GITHUB_REF#refs/tags/v}
            
            Publication automatique sur toutes les plateformes.
            
            ### ðŸ“¦ Installation
            
            **ðŸ³ Docker:**
            ```bash
            docker pull ceoseshell/gsql:${GITHUB_REF#refs/tags/v}
            ```
            
            **ðŸ PyPI:**
            ```bash
            pip install gsql==${GITHUB_REF#refs/tags/v}
            ```
            
            **ðŸ“¦ Anaconda:**
            ```bash
            conda install -c ceoseshell gsql=${GITHUB_REF#refs/tags/v}
            ```
            
            ### ðŸ”„ Versions synchronisÃ©es
            - âœ… `gsql/__init__.py`: ${GITHUB_REF#refs/tags/v}
            - âœ… `Dockerfile`: ${GITHUB_REF#refs/tags/v}
            - âœ… `conda.recipe/meta.yaml`: ${GITHUB_REF#refs/tags/v}
            - âœ… `setup.py`: Version automatique
            - âœ… `README.md`: ${GITHUB_REF#refs/tags/v}
            
            ### ðŸ”— Liens
            - [Documentation](https://github.com/gopu-inc/gsql/wiki)
            - [Code source](https://github.com/gopu-inc/gsql/tree/${{ github.ref }})
            
            *Publication automatisÃ©e le ${{ github.event.head_commit.timestamp }}*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
