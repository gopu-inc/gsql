name: üîÑ Mise √† jour Automatique des Versions

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  VERSION_FILE: "gsql/__init__.py"
  REPO: gopu-inc/gsql

permissions:
  contents: write
  pull-requests: write

jobs:
  # 1. LECTURE ET CALCUL DE VERSION
  version-manager:
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.read-version.outputs.current_version }}
      new_version: ${{ steps.calculate.outputs.new_version }}
      version_type: ${{ steps.calculate.outputs.version_type }}
    steps:
      - name: üì• Checkout avec historique
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GB_TOKEN }}  # VOTRE TOKEN
      
      - name: üîç Lire la version actuelle
        id: read-version
        run: |
          if [ -f "$VERSION_FILE" ]; then
            CURRENT_VERSION=$(grep -E "__version__\s*=\s*[\"'][0-9]+\.[0-9]+\.[0-9]+[\"']" "$VERSION_FILE" | head -1 | sed -E "s/.*[\"']([0-9]+\.[0-9]+\.[0-9]+)[\"'].*/\1/")
          fi
          
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION="0.1.0"
          fi
          
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "üìå Version actuelle: $CURRENT_VERSION"
      
      - name: üßÆ Calculer la nouvelle version
        id: calculate
        run: |
          CURRENT_VERSION="${{ steps.read-version.outputs.current_version }}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          if echo "$COMMIT_MSG" | grep -q -E "BREAKING CHANGE|feat!|major:"; then
            VERSION_TYPE="major"
          elif echo "$COMMIT_MSG" | grep -q -E "feat:|feature:|enhancement:"; then
            VERSION_TYPE="minor"
          else
            VERSION_TYPE="patch"
          fi
          
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          case "$VERSION_TYPE" in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "üìà Nouvelle version: $NEW_VERSION"

  # 2. MISE √Ä JOUR DES FICHIERS ET CR√âATION DE PR (avec votre token)
  update-versions:
    runs-on: ubuntu-latest
    needs: version-manager
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      version_updated: ${{ steps.update.outputs.version_updated }}
      pr_created: ${{ steps.create-pr.outputs.pr_created }}
    steps:
      - name: üì• Checkout avec votre token GB_TOKEN
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GB_TOKEN }}
          fetch-depth: 0
      
      - name: üîÑ Mettre √† jour les fichiers de version
        id: update
        run: |
          OLD_VERSION="${{ needs.version-manager.outputs.current_version }}"
          NEW_VERSION="${{ needs.version-manager.outputs.new_version }}"
          
          # V√©rifier si la version a chang√©
          if [ "$OLD_VERSION" = "$NEW_VERSION" ]; then
            echo "‚ÑπÔ∏è Version inchang√©e, pas de mise √† jour n√©cessaire"
            echo "version_updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "üîÑ Mise √† jour de $OLD_VERSION ‚Üí $NEW_VERSION"
          
          # 1. Source de v√©rit√©: gsql/__init__.py
          sed -i "s/__version__ = [\"']$OLD_VERSION[\"']/__version__ = \"$NEW_VERSION\"/g" "$VERSION_FILE"
          
          # 2. pyproject.toml (PyPI)
          if [ -f "pyproject.toml" ]; then
            sed -i "s/version = [\"'][^\"']*[\"']/version = \"$NEW_VERSION\"/g" pyproject.toml
          fi
          
          # 3. setup.py
          if [ -f "setup.py" ]; then
            sed -i "s/version=['\"][^'\"]*['\"]/version='$NEW_VERSION'/g" setup.py
          fi
          
          # 4. Dockerfile
          if [ -f "Dockerfile" ]; then
            sed -i "s/LABEL version=[\"'][^\"']*[\"']/LABEL version=\"$NEW_VERSION\"/g" Dockerfile 2>/dev/null || true
            sed -i "s/ARG VERSION=.*/ARG VERSION=$NEW_VERSION/g" Dockerfile 2>/dev/null || true
          fi
          
          # 5. Anaconda meta.yaml
          if [ -f "conda.recipe/meta.yaml" ]; then
            sed -i "s/version: [\"'][^\"']*[\"']/version: \"$NEW_VERSION\"/g" conda.recipe/meta.yaml
            sed -i "s/number: [0-9]*/number: ${{ github.run_number }}/g" conda.recipe/meta.yaml
          fi
          
          # 6. README.md
          if [ -f "README.md" ]; then
            sed -i "s/gsql==[0-9]\+\.[0-9]\+\.[0-9]\+/gsql==$NEW_VERSION/g" README.md 2>/dev/null || true
            sed -i "s/gsql:[0-9]\+\.[0-9]\+\.[0-9]\+/gsql:$NEW_VERSION/g" README.md 2>/dev/null || true
          fi
          
          echo "version_updated=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Fichiers mis √† jour"
      
      - name: üíæ Cr√©er une Pull Request avec votre token
        id: create-pr
        if: steps.update.outputs.version_updated == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GB_TOKEN }}  # VOTRE TOKEN ICI
          commit-message: "chore: bump version to ${{ needs.version-manager.outputs.new_version }}"
          title: "Version ${{ needs.version-manager.outputs.new_version }}"
          body: |
            ## üîÑ Mise √† jour automatique de version
            
            **Ancienne version:** ${{ needs.version-manager.outputs.current_version }}
            **Nouvelle version:** ${{ needs.version-manager.outputs.new_version }}
            **Type:** ${{ needs.version-manager.outputs.version_type }}
            
            ### üìÑ Fichiers modifi√©s:
            - `gsql/__init__.py` - Source de v√©rit√©
            - `pyproject.toml` / `setup.py` - PyPI
            - `Dockerfile` - Docker Hub
            - `conda.recipe/meta.yaml` - Anaconda
            - `README.md` - Documentation
            
            ### üöÄ Apr√®s merge:
            1. Cr√©ez un tag: `git tag v${{ needs.version-manager.outputs.new_version }}`
            2. Push le tag: `git push origin v${{ needs.version-manager.outputs.new_version }}`
            3. Le CI publiera automatiquement sur toutes les plateformes
            
            *Cette PR a √©t√© g√©n√©r√©e automatiquement par GitHub Actions.*
          branch: bump-version-${{ needs.version-manager.outputs.new_version }}
          delete-branch: true
          labels: "automated-pr,version-bump"
          draft: false
      
      - name: üìù Afficher le lien vers la PR
        if: steps.create-pr.outputs.pr_created == 'true'
        run: |
          echo "‚úÖ Pull Request cr√©√©e: ${{ steps.create-pr.outputs.pull-request-url }}"
          echo "üîó Lien: ${{ steps.create-pr.outputs.pull-request-url }}"
          echo ""
          echo "Pour publier apr√®s merge:"
          echo "git tag v${{ needs.version-manager.outputs.new_version }}"
          echo "git push origin v${{ needs.version-manager.outputs.new_version }}"

  # 3. PUBLICATION AUTOMATIQUE APR√àS TAG (avec votre token pour la release)
  publish-all:
    runs-on: ubuntu-latest
    needs: version-manager
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    env:
      VERSION: ${{ github.ref_name }}
      CLEAN_VERSION: ${{ github.ref_name }}
    steps:
      - name: üì• Checkout avec votre token
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GB_TOKEN }}
      
      - name: üîß Extraire la version du tag
        run: |
          CLEAN_VERSION=${VERSION#v}
          echo "CLEAN_VERSION=$CLEAN_VERSION" >> $GITHUB_ENV
          echo "üì¶ Version √† publier: $CLEAN_VERSION"
      
      - name: üê≥ Publication Docker Hub
        uses: docker/login-action@v3
        with:
          username: ceoseshell
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: üê≥ Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ceoseshell/gsql:latest
            ceoseshell/gsql:${{ env.CLEAN_VERSION }}
          labels: |
            version=${{ env.CLEAN_VERSION }}
            org.opencontainers.image.source=https://github.com/$REPO
            org.opencontainers.image.revision=${{ github.sha }}
      
      - name: üêç Publication PyPI
        run: |
          pip install build twine
          python -m build
          twine upload --username __token__ --password ${{ secrets.PYPI_TOKEN }} dist/*
      
      - name: üì¶ Publication Anaconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          python-version: 3.10
      
      - name: üèóÔ∏è Build Anaconda Package
        run: |
          conda install conda-build anaconda-client -y
          conda build conda.recipe/ --output-folder conda_pkg
      
      - name: üöÄ Upload vers Anaconda
        run: |
          PKG_FILE=$(find conda_pkg -name "*.tar.bz2" -type f | head -1)
          if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
            anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG_FILE"
          fi
      
      - name: üè∑Ô∏è GitHub Release (avec votre token)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release ${{ env.CLEAN_VERSION }}
          body: |
            ## üöÄ Version ${{ env.CLEAN_VERSION }}
            
            Publication automatique via GitHub Actions.
            
            ### üì¶ Installation
            
            **Docker:**
            ```bash
            docker pull ceoseshell/gsql:${{ env.CLEAN_VERSION }}
            ```
            
            **PyPI:**
            ```bash
            pip install gsql==${{ env.CLEAN_VERSION }}
            ```
            
            **Anaconda:**
            ```bash
            conda install -c ceoseshell gsql=${{ env.CLEAN_VERSION }}
            ```
            
            ### üîó Liens
            - [Documentation](https://github.com/$REPO/wiki)
            - [Code source](https://github.com/$REPO/tree/${{ github.ref }})
            
            *Auto-g√©n√©r√© le ${{ github.event.head_commit.timestamp }}*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GB_TOKEN }}  # VOTRE TOKEN POUR LES RELEASES

  # 4. OPTION: PUBLICATION IMM√âDIATE (d√©sactiv√©e par d√©faut)
  quick-publish:
    runs-on: ubuntu-latest
    needs: [version-manager, update-versions]
    # D√âSACTIV√â - Utilisez plut√¥t l'approche PR + Tag
    if: false
    steps:
      - name: üì• Checkout avec votre token
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GB_TOKEN }}
          fetch-depth: 0
      
      - name: üîß Configuration Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git remote set-url origin https://x-access-token:${{ secrets.GB_TOKEN }}@github.com/$REPO.git
      
      - name: üîÑ Appliquer les changements et push direct
        run: |
          NEW_VERSION="${{ needs.version-manager.outputs.new_version }}"
          
          git add -A
          git commit -m "chore: bump version to $NEW_VERSION"
          git push origin main
          
          # Cr√©er et pousser le tag
          git tag "v$NEW_VERSION"
          git push origin "v$NEW_VERSION"
