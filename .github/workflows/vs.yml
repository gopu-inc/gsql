name: ðŸš€ Publication Automatique sur Tag

on:
  push:
    tags:
      - 'v*'

env:
  VERSION_FILE: "gsql/__init__.py"
  DOCKER_FILE: "Dockerfile"
  CONDA_FILE: "conda.recipe/meta.yaml"
  SETUP_FILE: "setup.py"

permissions:
  contents: write

jobs:
  sync-versions:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout avec le tag
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ·ï¸ Extraire la version du tag
        id: extract-tag
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          echo "ðŸ·ï¸ Tag dÃ©tectÃ©: $TAG_VERSION"
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
      
      - name: ðŸ”„ Synchroniser TOUS les fichiers
        run: |
          TAG_VERSION="${{ steps.extract-tag.outputs.tag_version }}"
          echo "ðŸ”„ Synchronisation complÃ¨te vers: $TAG_VERSION"
          
          # 1. Mettre Ã  jour gsql/__init__.py
          sed -i 's/__version__ = ".*"/__version__ = "'"$TAG_VERSION"'"/g' "$VERSION_FILE"
          echo "âœ… $VERSION_FILE â†’ $TAG_VERSION"
          
          # 2. Mettre Ã  jour Dockerfile
          sed -i 's/ARG VERSION=".*"/ARG VERSION="'"$TAG_VERSION"'"/g' "$DOCKER_FILE"
          sed -i 's/LABEL version=".*"/LABEL version="'"$TAG_VERSION"'"/g' "$DOCKER_FILE"
          echo "âœ… Dockerfile synchronisÃ©"
          
          # 3. Mettre Ã  jour conda meta.yaml si existe
          if [ -f "$CONDA_FILE" ]; then
            sed -i 's/version: ".*"/version: "'"$TAG_VERSION"'"/g' "$CONDA_FILE"
            echo "âœ… $CONDA_FILE synchronisÃ©"
          fi
          
          # 4. Mettre Ã  jour README.md
          if [ -f "README.md" ]; then
            sed -i 's/gsql==[0-9]\+\.[0-9]\+\.[0-9]\+/gsql=='"$TAG_VERSION"'/g' "README.md" 2>/dev/null || true
            echo "âœ… README.md synchronisÃ©"
          fi

  publish-docker:
    runs-on: ubuntu-latest
    needs: sync-versions
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ³ Login Docker
        uses: docker/login-action@v3
        with:
          username: ceoseshell
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: ðŸ³ Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ceoseshell/gsql:latest
            ceoseshell/gsql:${GITHUB_REF#refs/tags/v}
          labels: |
            version=${GITHUB_REF#refs/tags/v}

  publish-pypi:
    runs-on: ubuntu-latest
    needs: sync-versions
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: ðŸ“¦ Build
        run: |
          pip install build
          python -m build
      
      - name: ðŸ“¤ Upload PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}

  publish-anaconda:
    runs-on: ubuntu-latest
    needs: sync-versions
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
      
      - name: ðŸ” VÃ©rifier ou crÃ©er meta.yaml
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          
          if [ ! -f "conda.recipe/meta.yaml" ]; then
            echo "âš ï¸ CrÃ©ation automatique de meta.yaml..."
            mkdir -p conda.recipe
            
            # CORRIGÃ‰: Utiliser des guillemets simples pour Ã©viter les problÃ¨mes d'Ã©chappement
            cat > conda.recipe/meta.yaml << 'EOF'
package:
  name: gsql
  version: "$TAG_VERSION"

source:
  url: https://pypi.io/packages/source/g/gsql/gsql-$TAG_VERSION.tar.gz

build:
  number: 0
  script: python -m pip install . --no-deps -vv

requirements:
  host:
    - python
    - pip
  run:
    - python

test:
  imports:
    - gsql

about:
  home: https://github.com/gopu-inc/gsql
  license: MIT
  summary: Complete SQL Database System in Python with AI Integration
EOF
            echo "âœ… meta.yaml crÃ©Ã© automatiquement"
          else
            echo "âœ… meta.yaml existe dÃ©jÃ "
          fi
      
      - name: ðŸ“¦ Installer conda-build
        run: conda install conda-build anaconda-client -y
      
      - name: ðŸ—ï¸ Build Conda Package
        run: |
          conda build conda.recipe/ --output-folder conda_pkg
          echo "ðŸ“¦ Packages gÃ©nÃ©rÃ©s:"
          find conda_pkg -name "*.tar.bz2" | xargs ls -la
      
      - name: ðŸš€ Upload vers Anaconda
        run: |
          PKG_FILE=$(find conda_pkg -name "*.tar.bz2" -type f | head -1)
          if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
            echo "ðŸ“¤ Upload du package: $PKG_FILE"
            anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG_FILE"
            echo "âœ… Package uploadÃ© avec succÃ¨s!"
          else
            echo "âŒ Aucun package Conda trouvÃ©"
            exit 1
          fi

  github-release:
    runs-on: ubuntu-latest
    needs: [publish-docker, publish-pypi, publish-anaconda]
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ·ï¸ CrÃ©er la Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release v${GITHUB_REF#refs/tags/v}
          body: |
            ## ðŸš€ GSQL v${GITHUB_REF#refs/tags/v}
            
            Publication automatique sur toutes les plateformes.
            
            ### ðŸ“¦ Installation
            
            **ðŸ³ Docker:**
            ```bash
            docker pull ceoseshell/gsql:${GITHUB_REF#refs/tags/v}
            ```
            
            **ðŸ PyPI:**
            ```bash
            pip install gsql==${GITHUB_REF#refs/tags/v}
            ```
            
            **ðŸ“¦ Anaconda:**
            ```bash
            conda install -c ceoseshell gsql=${GITHUB_REF#refs/tags/v}
            ```
            
            *Publication automatisÃ©e le ${{ github.event.head_commit.timestamp }}*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
