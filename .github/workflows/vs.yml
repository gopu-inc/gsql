name: üîÑ Mise √† jour Automatique des Versions

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  VERSION_FILE: "gsql/__init__.py"
  REPO: gopu-inc/gsql

jobs:
  # 1. LECTURE ET CALCUL DE VERSION
  version-manager:
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.read-version.outputs.current_version }}
      new_version: ${{ steps.calculate.outputs.new_version }}
      version_type: ${{ steps.calculate.outputs.version_type }}
    steps:
      - name: üì• Checkout avec historique
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîç Lire la version actuelle
        id: read-version
        run: |
          if [ -f "$VERSION_FILE" ]; then
            CURRENT_VERSION=$(grep -E "__version__\s*=\s*[\"'][0-9]+\.[0-9]+\.[0-9]+[\"']" "$VERSION_FILE" | head -1 | sed -E "s/.*[\"']([0-9]+\.[0-9]+\.[0-9]+)[\"'].*/\1/")
          fi
          
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION="0.1.0"
          fi
          
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "üìå Version actuelle: $CURRENT_VERSION"
      
      - name: üßÆ Calculer la nouvelle version
        id: calculate
        run: |
          CURRENT_VERSION="${{ steps.read-version.outputs.current_version }}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          if echo "$COMMIT_MSG" | grep -q -E "BREAKING CHANGE|feat!|major:"; then
            VERSION_TYPE="major"
          elif echo "$COMMIT_MSG" | grep -q -E "feat:|feature:|enhancement:"; then
            VERSION_TYPE="minor"
          else
            VERSION_TYPE="patch"
          fi
          
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          case "$VERSION_TYPE" in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "üìà Nouvelle version: $NEW_VERSION"

  # 2. MISE √Ä JOUR DES FICHIERS (SANS PUSH AUTOMATIQUE)
  update-versions:
    runs-on: ubuntu-latest
    needs: version-manager
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      version_updated: ${{ steps.update.outputs.version_updated }}
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîÑ Mettre √† jour les fichiers de version
        id: update
        run: |
          OLD_VERSION="${{ needs.version-manager.outputs.current_version }}"
          NEW_VERSION="${{ needs.version-manager.outputs.new_version }}"
          
          # V√©rifier si la version a chang√©
          if [ "$OLD_VERSION" = "$NEW_VERSION" ]; then
            echo "‚ÑπÔ∏è Version inchang√©e, pas de mise √† jour n√©cessaire"
            echo "version_updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "üîÑ Mise √† jour de $OLD_VERSION ‚Üí $NEW_VERSION"
          
          # 1. Source de v√©rit√©: gsql/__init__.py
          sed -i "s/__version__ = [\"']$OLD_VERSION[\"']/__version__ = \"$NEW_VERSION\"/g" "$VERSION_FILE"
          
          # 2. pyproject.toml (PyPI)
          if [ -f "pyproject.toml" ]; then
            sed -i "s/version = [\"'][^\"']*[\"']/version = \"$NEW_VERSION\"/g" pyproject.toml
          fi
          
          # 3. setup.py
          if [ -f "setup.py" ]; then
            sed -i "s/version=['\"][^'\"]*['\"]/version='$NEW_VERSION'/g" setup.py
          fi
          
          # 4. Dockerfile
          if [ -f "Dockerfile" ]; then
            sed -i "s/LABEL version=[\"'][^\"']*[\"']/LABEL version=\"$NEW_VERSION\"/g" Dockerfile 2>/dev/null || true
            sed -i "s/ARG VERSION=.*/ARG VERSION=$NEW_VERSION/g" Dockerfile 2>/dev/null || true
          fi
          
          # 5. Anaconda meta.yaml
          if [ -f "conda.recipe/meta.yaml" ]; then
            sed -i "s/version: [\"'][^\"']*[\"']/version: \"$NEW_VERSION\"/g" conda.recipe/meta.yaml
            sed -i "s/number: [0-9]*/number: ${{ github.run_number }}/g" conda.recipe/meta.yaml
          fi
          
          # 6. README.md
          if [ -f "README.md" ]; then
            sed -i "s/gsql==[0-9]\+\.[0-9]\+\.[0-9]\+/gsql==$NEW_VERSION/g" README.md 2>/dev/null || true
            sed -i "s/gsql:[0-9]\+\.[0-9]\+\.[0-9]\+/gsql:$NEW_VERSION/g" README.md 2>/dev/null || true
          fi
          
          echo "version_updated=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Fichiers mis √† jour"
      
      - name: üíæ Cr√©er une Pull Request pour les changements
        if: steps.update.outputs.version_updated == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: bump version to ${{ needs.version-manager.outputs.new_version }}"
          title: "Version ${{ needs.version-manager.outputs.new_version }}"
          body: |
            ## Mise √† jour automatique de version
            
            Version: **${{ needs.version-manager.outputs.current_version }} ‚Üí ${{ needs.version-manager.outputs.new_version }}**
            
            Fichiers modifi√©s:
            - `gsql/__init__.py`
            - `pyproject.toml` ou `setup.py`
            - `Dockerfile`
            - `conda.recipe/meta.yaml`
            - `README.md`
            
            *Cette PR a √©t√© g√©n√©r√©e automatiquement par GitHub Actions.*
          branch: bump-version-${{ needs.version-manager.outputs.new_version }}
          delete-branch: true
          labels: "automated-pr,version-bump"

  # 3. PUBLICATION (seulement apr√®s merge manuel)
  publish-all:
    runs-on: ubuntu-latest
    needs: version-manager
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    env:
      VERSION: ${{ github.ref_name }}
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üê≥ Publication Docker
        uses: docker/login-action@v3
        with:
          username: ceoseshell
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: üê≥ Build & Push Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ceoseshell/gsql:latest
            ceoseshell/gsql:${VERSION#v}
      
      - name: üêç Publication PyPI
        run: |
          pip install build twine
          python -m build
          twine upload --username __token__ --password ${{ secrets.PYPI_TOKEN }} dist/*
      
      - name: üì¶ Publication Anaconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
      
      - name: üèóÔ∏è Build Anaconda Package
        run: |
          conda install conda-build anaconda-client -y
          conda build conda.recipe/ --output-folder conda_pkg
          anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell conda_pkg/linux-64/*.tar.bz2
      
      - name: üè∑Ô∏è GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release ${{ github.ref_name }}
          generate_release_notes: true

  # 4. WORKFLOW ALTERNATIF: Publication imm√©diate (si vous pr√©f√©rez)
  quick-publish:
    runs-on: ubuntu-latest
    needs: [version-manager, update-versions]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.update-versions.outputs.version_updated == 'true'
    # D√âCOMMENTER pour activer la publication imm√©diate:
    # if: false  # D√©sactiv√© par d√©faut
    steps:
      - name: üì• Checkout avec permissions √©tendues
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}  # √Ä cr√©er
          fetch-depth: 0
      
      - name: üîß Configuration Git
        run: |
          git config --global user.email "votre-email@example.com"
          git config --global user.name "Votre Nom"
      
      - name: üîÑ Appliquer les changements de version
        run: |
          git add -A
          git commit -m "chore: bump version to ${{ needs.version-manager.outputs.new_version }}"
          git push origin main
