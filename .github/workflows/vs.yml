name: üöÄ Publication Multi-Plateformes

on:
  push:
    branches: main
    # Se d√©clenche seulement sur les tags de version (ex: v3.0.1)

jobs:
  # 1. PUBLICATION DOCKER
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üê≥ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ceoseshell
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: üîß Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc \
            g++ \
            build-essential \
            python3-dev
      
      - name: üìù Update README with Docker version
        run: |
          # Mettre √† jour la version Docker dans le README
          sed -i 's/gsql:latest/gsql:3.0.1/g' README.md 2>/dev/null || true
          sed -i 's/docker version: .*/docker version: 3.0.1/g' README.md 2>/dev/null || true
          
          # Ajouter section documentation Docker
          if ! grep -q "## Docker" README.md; then
            echo -e "\n## Docker\n\n```bash\ndocker pull ceoseshell/gsql:3.0.1\ndocker run -it ceoseshell/gsql:3.0.1\n```" >> README.md
          fi
      
      - name: üê≥ Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ceoseshell/gsql:latest
            ceoseshell/gsql:${{ github.ref_name }}
            ceoseshell/gsql:3.0.1
          labels: |
            version=3.0.1
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.source=${{ github.event.repository.html_url }}

  # 2. PUBLICATION PYPI
  pypi:
    runs-on: ubuntu-latest
    needs: [docker]  # D√©pend du job docker
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: üì¶ Install build tools
        run: pip install build twine
      
      - name: üèóÔ∏è Build Package
        run: python -m build
      
      - name: üß™ Verify Package
        run: twine check dist/*
      
      - name: üì§ Upload to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}

  # 3. PUBLICATION ANACONDA (VRAI PACKAGE CONDA)
  anaconda:
    runs-on: ubuntu-latest
    needs: [pypi]  # D√©pend du job PyPI
    strategy:
      matrix:
        platform: [linux-64, osx-64, win-64, noarch, pycharm]  # Multi-plateformes
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üêç Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          miniconda-version: "latest"
          python-version: 3.10
      
      - name: üì¶ Install conda-build et anaconda-client
        run: conda install conda-build anaconda-client -y
      
      - name: üèóÔ∏è Build Conda Package
        run: |
          # Construire le package Conda
          conda build conda.recipe/ --output-folder conda_pkg
          
          # Lister les fichiers g√©n√©r√©s
          find conda_pkg -type f -name "*.tar.bz2" | xargs ls -la
      
      - name: üöÄ Upload vers Anaconda
        run: |
          # Upload pour la plateforme sp√©cifique
          if [ "${{ matrix.platform }}" = "noarch" ]; then
            # Chercher les packages noarch
            PKG_FILE=$(find conda_pkg -name "*.tar.bz2" -type f | head -1)
          else
            # Chercher les packages pour la plateforme sp√©cifique
            PKG_FILE=$(find conda_pkg/${{ matrix.platform }} -name "*.tar.bz2" -type f 2>/dev/null || echo "")
          fi
          
          if [ -n "$PKG_FILE" ] && [ -f "$PKG_FILE" ]; then
            echo "üì§ Upload du package: $PKG_FILE"
            anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload --user ceoseshell "$PKG_FILE"
          else
            echo "‚ö†Ô∏è Aucun package trouv√© pour ${{ matrix.platform }}"
          fi
        env:
          ANACONDA_TOKEN: ${{ secrets.ANACONDA_TOKEN }}

  # 4. NOTIFICATION (Optionnel)
  notification:
    runs-on: ubuntu-latest
    needs: [docker, pypi, anaconda]
    if: always()
    steps:
      - name: üìä Status Report
        run: |
          echo "üì¶ Publication termin√©e !"
          echo "Docker: ceoseshell/gsql:3.0.1"
          echo "PyPI: https://pypi.org/project/gsql/3.0.1/"
          echo "Anaconda: https://anaconda.org/ceoseshell/gsql"
